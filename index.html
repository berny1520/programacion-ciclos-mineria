<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Software Minero - Asefortmec SPA</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; background: #f0f2f5; }
    h2, h3 { color: #003366; }
    input, select { margin: 5px; padding: 5px; width: 100%; }
    .seccion { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 0 10px #ccc; }
    .btn { padding: 10px; margin: 5px; border: none; border-radius: 5px; background: #0066cc; color: white; cursor: pointer; }
    .btn-red { background-color: #cc3300; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; text-align: center; }
    th { background-color: #003366; color: white; }
    canvas { background: white; border-radius: 10px; padding: 20px; }
  </style>
</head>
<body>
  <h2>Software de Programaci√≥n Minera - Asefortmec SPA</h2>

  <div class="seccion">
    <h3>Ingreso de Frente</h3>
    <label>Nombre del Frente: <input id="nombreFrente"></label>
    <label>Secci√≥n del Frente:
      <select id="seccionFrente">
        <option>5.5 x 5.2</option><option>4.5 x 4.5</option><option>6.0 x 6.0</option><option>7.0 x 7.0</option>
      </select></label>
    <label>Largo (m): <input id="largoFrente" type="number" step="0.1"></label>
    <label>Densidad (ton/m¬≥): 
      <select id="densidad"><option value="1.6">1.6</option><option value="1.8">1.8</option><option value="2.0">2.0</option><option value="2.2">2.2</option></select>
    </label>
    <label>Equipo:
      <select id="equipo">
        <option value="S1D">S1D</option><option value="282">282</option><option value="M2C">M2C</option>
        <option value="E2C">E2C</option><option value="XE3C">XE3C</option><option value="S2">S2</option>
      </select></label>
    <label>Perforaciones: <input id="perforaciones" type="number"></label>
    <label>Tiempo por Perforaci√≥n (min): <input id="tiempoPerf" type="number"></label>
    <label>Disparo (min): <input id="disparo" type="number"></label>
    <label>Ventilaci√≥n (min): <input id="ventilacion" type="number"></label>
    <label>Extracci√≥n (min): <input id="extraccion" type="number"></label>
    <label>Proyecci√≥n (min): <input id="proyeccion" type="number"></label>
    <label>Acu√±adura (min): <input id="acunadura" type="number"></label>
    <button class="btn" onclick="agregarFrente()">Agregar Frente</button>
    <button class="btn" onclick="exportarCSV()">üì§ Exportar a CSV</button>
  </div>

  <div class="seccion">
    <h3>Resumen de Frentes</h3>
    <table id="tablaFrentes">
      <thead>
        <tr><th>Frente</th><th>Equipo</th><th>Perfs</th><th>Ton</th><th>Min</th><th>Hr</th><th>Editar</th><th>Eliminar</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="seccion">
    <h3>Resumen por Equipo</h3>
    <table id="tablaResumen">
      <thead><tr><th>Equipo</th><th>Frentes</th><th>Toneladas</th><th>Minutos</th></tr></thead>
      <tbody></tbody>
    </table>
    <canvas id="graficoToneladas" height="150"></canvas>
    <canvas id="graficoTiempo" height="150"></canvas>
  </div>

<script>
const brazosEquipo = {{ S1D: 1, "282": 1, M2C: 2, E2C: 2, XE3C: 3, S2: 2 }};
let frentes = [];

function agregarFrente() {
  const nombre = v("nombreFrente"), seccion = v("seccionFrente"), largo = +v("largoFrente"), densidad = +v("densidad");
  const equipo = v("equipo"), perfs = +v("perforaciones"), tperf = +v("tiempoPerf"), disparo = +v("disparo");
  const vent = +v("ventilacion"), extr = +v("extraccion"), proy = +v("proyeccion"), acu = +v("acunadura");

  const [ancho, alto] = seccion.split("x").map(Number);
  const volumen = ancho * alto * largo;
  const ton = volumen * densidad;
  const brazos = brazosEquipo[equipo];
  const tPerforar = (perfs * tperf) / brazos;
  const totalMin = tPerforar + disparo + vent + extr + proy + acu;
  const totalHr = (totalMin / 60).toFixed(2);

  frentes.push({ nombre, equipo, perfs, toneladas: ton.toFixed(1), tiempo: Math.round(totalMin), horas: totalHr });
  guardar();
  render();
}

function render() {
  const tb = document.querySelector("#tablaFrentes tbody");
  tb.innerHTML = "";
  frentes.forEach((f, i) => {
    tb.innerHTML += `<tr><td>${f.nombre}</td><td>${f.equipo}</td><td>${f.perfs}</td><td>${f.toneladas}</td><td>${f.tiempo}</td><td>${f.horas}</td>
    <td><button class='btn' onclick='editar(${i})'>‚úèÔ∏è</button></td>
    <td><button class='btn btn-red' onclick='eliminar(${i})'>üóëÔ∏è</button></td></tr>`;
  });
  resumenEquipo();
}

function exportarCSV() {
  let csv = "Frente,Equipo,Perfs,Toneladas,Min,Hor\n";
  frentes.forEach(f => csv += `${f.nombre},${f.equipo},${f.perfs},${f.toneladas},${f.tiempo},${f.horas}\n`);
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "frentes_Asefortmec.csv";
  a.click();
}

function editar(i) {
  const f = frentes[i];
  const nuevo = prompt("Editar (nombre,equipo,perfs,ton,tiempo):", `${f.nombre},${f.equipo},${f.perfs},${f.toneladas},${f.tiempo}`);
  if (nuevo) {
    const [n, e, p, t, m] = nuevo.split(",");
    frentes[i] = { nombre: n, equipo: e, perfs: +p, toneladas: t, tiempo: +m, horas: (+m/60).toFixed(2) };
    guardar();
    render();
  }
}

function eliminar(i) {
  if (confirm("¬øEliminar?")) { frentes.splice(i, 1); guardar(); render(); }
}

function resumenEquipo() {
  const resumen = {};
  frentes.forEach(f => {
    if (!resumen[f.equipo]) resumen[f.equipo] = { frentes: 0, toneladas: 0, tiempo: 0 };
    resumen[f.equipo].frentes += 1;
    resumen[f.equipo].toneladas += +f.toneladas;
    resumen[f.equipo].tiempo += f.tiempo;
  });
  const tr = document.querySelector("#tablaResumen tbody");
  tr.innerHTML = "";
  const etiquetas = [], dataTon = [], dataMin = [];
  for (const e in resumen) {
    const r = resumen[e];
    tr.innerHTML += `<tr><td>${e}</td><td>${r.frentes}</td><td>${r.toneladas.toFixed(1)}</td><td>${r.tiempo}</td></tr>`;
    etiquetas.push(e); dataTon.push(r.toneladas); dataMin.push(r.tiempo);
  }
  graficar("graficoToneladas", "Toneladas por Equipo", etiquetas, dataTon, "#3399ff");
  graficar("graficoTiempo", "Minutos por Equipo", etiquetas, dataMin, "#cc6600");
}

function graficar(id, label, labels, data, color) {
  new Chart(document.getElementById(id), {
    type: "bar",
    data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: color }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

function guardar() {
  localStorage.setItem("frentesAsefortmec", JSON.stringify(frentes));
}

function v(id) { return document.getElementById(id).value; }

window.onload = () => {
  const guardados = localStorage.getItem("frentesAsefortmec");
  if (guardados) frentes = JSON.parse(guardados);
  render();
}
</script>
</body>
</html>